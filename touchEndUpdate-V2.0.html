<!-- 上拉刷新 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no"/>
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta content="email=no" name="format-detection">

    <title>XXX-xxx</title>
    <link href="./css/awesome.css" rel="stylesheet">
    <link href="./css/base.css" rel="stylesheet">
    <link href="./css/common.css" rel="stylesheet">
    <link href="./css/iSlider.css" rel="stylesheet">
    <link href="./css/index.css" rel="stylesheet">
    
    <script type="text/javascript" src="./js/jquery1.10.2.js"></script>
    <script type="text/javascript" src="./js/fontSize.js"></script>
    <script type="text/javascript" src="./js/common.js"></script>
    <script type="text/javascript" src="./js/iSlider.js"></script>
    <script type="text/javascript" src="./js/iSlider.animate.js"></script>
    <script type="text/javascript" src="./js/iSlider.dot.js"></script>
    <script type="text/javascript" src="./js/iSlider.plugin.button.js"></script>
    <script type="text/javascript" src='./layer/layer.js'></script>
    <style>
        body {
            background-color: gray;
        }
        #test {
            position: relative;
        }
        #test ul {
        }
        #test p {
        }
    </style>
</head>
<body>
    <div id="test">
        <ul class='content_wrapper'>
            <li>https://www.cnblogs.com/koubazhuanshu/p/7039531.html</li>
            <li>1</li>
            <li>3</li>
            <li>1</li>
            <li>1</li>
            <li>10</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>18</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>1</li>
            <li>21</li>
        </ul>
        <p style="display: none;width: 100%;text-align: center;" id='loading-txt'><img style='width:2rem;height:.5rem;display: inline-block;' src="./img/loading.svg" alt=""></p>
    </div>
<script>
    $(function () {
        // 上拉刷新
        !function () {
            var loadingEle = document.getElementById("loading-txt");
            var ulContent = document.querySelector('.content_wrapper');
            var isLoading = false; // 只有为false 才可以执行刷新
            window.addEventListener('touchmove', function () {
                var curScrollTop = getScrollTop();
                var clientHeight = getClientHeight();
                var totalHeight = getScrollHeight();
                if (curScrollTop + clientHeight == totalHeight && isLoading == false) {
                    isLoading = true;
                    loadingEle.style.display = 'block';

                    // ajax 成功后追加dom 然后执行isLoading = false loadingEle.style.display = 'none'
                    clearTimeout(timerAjax);
                    var timerAjax = setTimeout(function () {
                        isLoading = false;
                        loadingEle.style.display = 'none';

                        var node=document.createElement("li");
                        node.innerHTML = 'ddddd';

                        ulContent.appendChild(node); // 必须追加节点
                    }, 3000);

                    // 节流
                    clearTimeout(timer);
                    var timer = setTimeout(function () {
                        isLoading = false; // 当第一次上拉 值变为true 再次快速上拉 isLoading因为是true 不执行if内语句 起到节流作用
                    }, 1000);
                }
            });

            // 获取元素滚动高度
            function getScrollTop() { 
                var scrollTop = 0; 
                if (document.documentElement && document.documentElement.scrollTop) { 
                    scrollTop = document.documentElement.scrollTop; 
                } else if (document.body) { 
                    scrollTop = document.body.scrollTop; 
                } 
                return scrollTop; 
            }

            // 获取当前可视范围的高度
            function getClientHeight() { 
                var clientHeight = 0; 
                if (document.body.clientHeight && document.documentElement.clientHeight) { 
                clientHeight = Math.min(document.body.clientHeight, document.documentElement.clientHeight); 
                } 
                else { 
                clientHeight = Math.max(document.body.clientHeight, document.documentElement.clientHeight); 
                } 
                return clientHeight; 
            }

            // 获取文档完整的高度
            function getScrollHeight() { 
                return Math.max(document.body.scrollHeight, document.documentElement.scrollHeight); 
            }
        }();

    });
</script>    
</body>

</html>